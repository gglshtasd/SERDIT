<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SERDIT | The Void</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;500;700;900&family=JetBrains+Mono:wght@400&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">

    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>

    <style>
        /* --- THEME: THE VOID (v4 Refined) --- */
        :root {
            --bg: #030305;
            --surface: #0a0a0f;
            --surface-2: #13131a;
            --border: #1f1f2e;
            
            --neon-p: #a855f7; /* Purple */
            --neon-b: #3b82f6; /* Blue */
            --neon-alert: #f43f5e; /* Red for Login/Admin */
            --text: #e2e8f0;
            --muted: #64748b;
            
            --nav-height: 70px;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; outline: none; }
        
        body {
            font-family: 'Outfit', sans-serif;
            background-color: var(--bg);
            color: var(--text);
            height: 100vh;
            overflow: hidden;
            display: flex;
            background-image: radial-gradient(circle at 10% 20%, rgba(168, 85, 247, 0.08) 0%, transparent 25%),
                              radial-gradient(circle at 90% 80%, rgba(59, 130, 246, 0.08) 0%, transparent 25%);
        }

        /* --- LAYOUT STRUCTURE --- */
        .app-container { flex: 1; display: flex; position: relative; height: 100%; width: 100%; }
        
        /* PC Sidebar */
        .sidebar {
            width: 80px; background: var(--surface); border-right: 1px solid var(--border);
            display: flex; flex-direction: column; align-items: center; padding: 20px 0; z-index: 50;
        }
        
        /* Mobile Bottom Nav */
        .mobile-nav {
            display: none; position: fixed; bottom: 0; left: 0; width: 100%; height: var(--nav-height);
            background: rgba(10, 10, 15, 0.95); backdrop-filter: blur(20px);
            border-top: 1px solid var(--border); z-index: 100;
            justify-content: space-around; align-items: center;
        }

        .nav-btn {
            width: 50px; height: 50px; border-radius: 16px; border: none; background: transparent;
            color: var(--muted); font-size: 1.5rem; cursor: pointer; transition: 0.3s;
            display: flex; align-items: center; justify-content: center; position: relative; margin-bottom: 15px;
        }
        .nav-btn:hover { color: white; background: rgba(255,255,255,0.05); }
        .nav-btn.active { color: var(--neon-b); background: rgba(59, 130, 246, 0.1); box-shadow: 0 0 15px rgba(59, 130, 246, 0.2); }
        
        /* Login/Auth Button Styles */
        .auth-btn-glow {
            color: var(--neon-alert);
            animation: pulse-red 2s infinite;
        }
        @keyframes pulse-red {
            0% { box-shadow: 0 0 0 0 rgba(244, 63, 94, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(244, 63, 94, 0); }
            100% { box-shadow: 0 0 0 0 rgba(244, 63, 94, 0); }
        }

        /* --- MAIN VIEWS --- */
        .view { flex: 1; display: none; flex-direction: column; height: 100%; overflow: hidden; animation: fadeIn 0.4s cubic-bezier(0.16, 1, 0.3, 1); }
        .view.active { display: flex; }
        
        /* Header */
        .header {
            height: 70px; padding: 0 25px; border-bottom: 1px solid var(--border);
            display: flex; justify-content: space-between; align-items: center;
            background: rgba(3, 3, 5, 0.8); backdrop-filter: blur(10px); z-index: 10;
        }
        .page-title { font-weight: 800; font-size: 1.5rem; letter-spacing: -1px; background: linear-gradient(to right, white, var(--muted)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }

        /* --- VIEW 1: MESSAGING --- */
        .msg-layout { display: flex; height: 100%; }
        .inbox-list { width: 350px; border-right: 1px solid var(--border); background: var(--surface-2); display: flex; flex-direction: column; }
        .chat-area { flex: 1; display: flex; flex-direction: column; background: var(--bg); position: relative; }
        
        .chat-tabs { display: flex; padding: 15px; gap: 10px; }
        .chat-tab { flex: 1; padding: 10px; background: var(--surface); border: 1px solid var(--border); color: var(--muted); border-radius: 8px; cursor: pointer; font-size: 0.85rem; text-align: center; transition:0.2s; font-weight: 600; }
        .chat-tab.active { background: var(--neon-b); color: white; border-color: var(--neon-b); }

        .inbox-item { padding: 15px; border-bottom: 1px solid var(--border); cursor: pointer; display: flex; align-items: center; gap: 15px; transition: 0.2s; }
        .inbox-item:hover { background: rgba(255,255,255,0.03); }
        .avatar { width: 45px; height: 45px; border-radius: 12px; background: linear-gradient(135deg, var(--surface), var(--border)); border: 1px solid var(--border); display: flex; align-items: center; justify-content: center; font-weight: bold; color: var(--neon-p); font-size: 1.2rem; }
        
        /* Messages */
        .msg-feed { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 15px; }
        .bubble { max-width: 75%; padding: 12px 18px; border-radius: 18px; font-size: 0.95rem; position: relative; line-height: 1.5; }
        .bubble.mine { align-self: flex-end; background: linear-gradient(135deg, var(--neon-b), var(--neon-p)); color: white; border-bottom-right-radius: 4px; box-shadow: 0 4px 15px rgba(59, 130, 246, 0.2); }
        .bubble.theirs { align-self: flex-start; background: var(--surface-2); border: 1px solid var(--border); border-bottom-left-radius: 4px; color: var(--text); }
        
        .timer-badge { font-size: 0.7rem; display: inline-flex; align-items: center; gap: 3px; background: rgba(0,0,0,0.3); padding: 2px 6px; border-radius: 4px; margin-top: 5px; opacity: 0.8; }
        .msg-img { max-width: 100%; border-radius: 10px; margin-top: 5px; cursor: pointer; border: 1px solid rgba(255,255,255,0.1); transition: 0.2s; }
        .msg-img:hover { opacity: 0.9; }

        /* --- VIEW 2: 3D GALLERY (DEFAULT) --- */
        .gallery-3d-container {
            flex: 1; padding: 30px; overflow-y: auto; perspective: 1200px;
            display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 25px;
            align-content: start;
        }
        .art-card {
            aspect-ratio: 3/4; border-radius: 16px; overflow: hidden; position: relative;
            background: var(--surface); border: 1px solid var(--border); cursor: pointer;
            transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275), border-color 0.3s;
            transform-style: preserve-3d; box-shadow: 0 10px 40px rgba(0,0,0,0.5);
        }
        .art-card:hover { transform: translateZ(30px) scale(1.05) rotateX(2deg); border-color: var(--neon-b); z-index: 100; }
        .art-card img { width: 100%; height: 100%; object-fit: cover; }
        .art-overlay {
            position: absolute; bottom: 0; left: 0; width: 100%; padding: 20px;
            background: linear-gradient(to top, rgba(0,0,0,0.9), transparent); opacity: 1;
        }

        /* --- ADMIN SPY PANEL --- */
        .spy-table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        .spy-row { border-bottom: 1px solid var(--border); font-family: 'JetBrains Mono', monospace; font-size: 0.8rem; }
        .spy-row td { padding: 12px; }
        .spy-btn { padding: 6px 12px; background: var(--surface-2); border: 1px solid var(--border); color: var(--text); cursor: pointer; border-radius: 6px; transition: 0.2s; }
        .spy-btn:hover { border-color: var(--danger); color: var(--danger); }

        /* --- MODALS & UTILS --- */
        .modal-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.9); backdrop-filter: blur(20px);
            z-index: 200; display: none; align-items: center; justify-content: center;
            opacity: 0; transition: opacity 0.3s;
        }
        .modal-overlay.active { display: flex; opacity: 1; }
        .modal-card { width: 90%; max-width: 420px; background: var(--surface); border: 1px solid var(--border); border-radius: 24px; padding: 35px; box-shadow: 0 20px 60px rgba(0,0,0,0.6); transform: scale(0.95); transition: transform 0.3s; }
        .modal-overlay.active .modal-card { transform: scale(1); }
        
        .input-group { background: var(--bg); border: 1px solid var(--border); padding: 14px; border-radius: 12px; display: flex; gap: 10px; margin-bottom: 12px; transition: 0.2s; }
        .input-group:focus-within { border-color: var(--neon-b); }
        .input-group input { background: transparent; border: none; color: white; flex: 1; font-size: 1rem; }
        
        .btn-main { width: 100%; padding: 16px; background: var(--text); color: black; border: none; border-radius: 12px; font-weight: 700; cursor: pointer; font-size: 1rem; margin-top: 10px; transition: 0.2s; }
        .btn-main:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(255,255,255,0.1); }
        .btn-neon { background: var(--neon-b); color: white; }
        .btn-neon:hover { box-shadow: 0 5px 20px rgba(59, 130, 246, 0.4); }

        .hidden { display: none !important; }

        /* --- MOBILE RESPONSIVE --- */
        @media (max-width: 768px) {
            .sidebar { display: none; }
            .mobile-nav { display: flex; }
            .app-container { height: calc(100vh - var(--nav-height)); }
            
            .msg-layout { position: relative; }
            .inbox-list { width: 100%; border-right: none; }
            .chat-area { 
                position: absolute; inset: 0; transform: translateX(100%); transition: 0.3s cubic-bezier(0.16, 1, 0.3, 1); 
                z-index: 50; background: var(--bg);
            }
            .chat-area.open { transform: translateX(0); }
            
            #back-btn { display: block !important; }
            
            .gallery-3d-container { padding: 15px; grid-template-columns: repeat(2, 1fr); gap: 15px; }
            
            /* Make login button on mobile prominent */
            #mob-auth-btn { background: var(--surface-2); border: 1px solid var(--border); }
        }
        @media (min-width: 769px) {
            #back-btn { display: none; }
        }

        /* Animations */
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.98); } to { opacity: 1; transform: scale(1); } }
    </style>
</head>
<body>

    <!-- 1. PC SIDEBAR -->
    <nav class="sidebar">
        <div style="font-weight:900; color:white; font-size:1.5rem; margin-bottom:40px; color:var(--neon-b); cursor:default;">S</div>
        
        <!-- Navigation -->
        <button id="nav-gallery" class="nav-btn active" onclick="switchView('gallery')" title="Public Gallery"><i class="ri-layout-masonry-fill"></i></button>
        <button id="nav-msg" class="nav-btn" onclick="switchView('messaging')" title="Messages"><i class="ri-mail-fill"></i></button>
        <button class="nav-btn" onclick="toggleModal('upload')" title="Upload"><i class="ri-add-circle-fill"></i></button>
        
        <div style="flex:1"></div>
        
        <!-- ADMIN (Hidden by default) -->
        <button id="desk-admin-btn" class="nav-btn hidden" onclick="toggleModal('admin')" style="color:var(--danger)" title="God Mode"><i class="ri-eye-2-fill"></i></button>
        
        <!-- AUTH/PROFILE (High Visibility) -->
        <button id="desk-auth-btn" class="nav-btn auth-btn-glow" onclick="toggleModal('auth')" title="Connect"><i class="ri-user-3-fill"></i></button>
    </nav>

    <!-- 2. MOBILE BOTTOM NAV -->
    <nav class="mobile-nav">
        <button id="mob-nav-gallery" class="nav-btn active" onclick="switchView('gallery')"><i class="ri-layout-masonry-fill"></i></button>
        <button id="mob-nav-msg" class="nav-btn" onclick="switchView('messaging')"><i class="ri-mail-fill"></i></button>
        <button class="nav-btn" onclick="toggleModal('upload')" style="color:white; background:var(--neon-b); border-radius:50%; margin-bottom:30px; width:60px; height:60px; box-shadow:0 0 20px rgba(59, 130, 246, 0.4); border:2px solid var(--bg);"><i class="ri-add-line"></i></button>
        
        <!-- ADMIN (Hidden) -->
        <button id="mob-admin-btn" class="nav-btn hidden" onclick="toggleModal('admin')" style="color:var(--danger)"><i class="ri-eye-2-fill"></i></button>
        
        <!-- AUTH -->
        <button id="mob-auth-btn" class="nav-btn auth-btn-glow" onclick="toggleModal('auth')"><i class="ri-user-3-fill"></i></button>
    </nav>

    <div class="app-container">
        
        <!-- === VIEW 1: PUBLIC GALLERY (DEFAULT LANDING) === -->
        <section id="view-gallery" class="view active">
            <div class="header">
                <div class="page-title">Serdit Grid</div>
                <div style="display:flex; gap:10px;">
                    <select id="gallery-filter" onchange="renderGallery()" style="background:var(--surface-2); color:white; border:1px solid var(--border); padding:8px 12px; border-radius:8px; outline:none; cursor:pointer;">
                        <option value="all">Global Feed</option>
                        <option value="trending">Top Rated</option>
                    </select>
                </div>
            </div>
            <div id="gallery-grid" class="gallery-3d-container">
                <div style="grid-column:1/-1; text-align:center; padding-top:50px; color:var(--muted);">
                    <i class="ri-loader-4-line ri-spin" style="font-size:2rem; margin-bottom:10px;"></i><br>Connecting to Void...
                </div>
            </div>
        </section>

        <!-- === VIEW 2: MESSAGING === -->
        <section id="view-messaging" class="view">
            <div class="msg-layout">
                <!-- Inbox List -->
                <div class="inbox-list">
                    <div style="padding:25px; border-bottom:1px solid var(--border);">
                        <h2 style="font-weight:800; margin-bottom:15px; font-size:1.4rem;">Inbox</h2>
                        <div class="chat-tabs">
                            <div class="chat-tab active" onclick="filterChats('dm')">Private</div>
                            <div class="chat-tab" onclick="filterChats('group')">Channels</div>
                        </div>
                        <button onclick="toggleModal('new-chat')" style="width:100%; padding:12px; margin-top:15px; background:rgba(255,255,255,0.03); border:1px dashed var(--border); color:var(--neon-b); border-radius:10px; cursor:pointer; font-weight:600; transition:0.2s;">+ New Transmission</button>
                    </div>
                    <div id="inbox-container" style="flex:1; overflow-y:auto;">
                        <!-- Injected JS -->
                    </div>
                </div>

                <!-- Active Chat Area -->
                <div id="chat-stage" class="chat-area">
                    <div class="header">
                        <button id="back-btn" onclick="closeChatMobile()" style="background:none; border:none; color:white; font-size:1.5rem; margin-right:15px;"><i class="ri-arrow-left-line"></i></button>
                        <div style="flex:1;">
                            <h3 id="chat-header-name" style="font-size:1.1rem;">Select a frequency</h3>
                            <div id="chat-header-status" style="font-size:0.75rem; color:var(--neon-b); opacity:0.7;">End-to-End Encrypted</div>
                        </div>
                        <button style="background:none; border:none; color:var(--muted); font-size:1.2rem;"><i class="ri-shield-check-fill"></i></button>
                    </div>
                    
                    <div id="msg-feed" class="msg-feed"></div>
                    
                    <form onsubmit="sendMessage(event)" style="padding:15px; border-top:1px solid var(--border); background:var(--surface);">
                        <div style="display:flex; gap:10px; align-items:center;">
                            <!-- Ephemeral Timer -->
                            <select id="timer-select" style="background:var(--bg); color:var(--danger); border:1px solid var(--border); padding:8px; border-radius:8px; font-size:0.8rem; cursor:pointer;">
                                <option value="0">Keep</option>
                                <option value="86400000">24h</option>
                                <option value="172800000">48h</option>
                            </select>
                            
                            <button type="button" onclick="document.getElementById('chat-file').click()" style="background:none; border:none; color:var(--neon-b); font-size:1.4rem; padding:0 5px; cursor:pointer;"><i class="ri-image-add-line"></i></button>
                            <input type="file" id="chat-file" style="display:none;" onchange="sendChatImage()">
                            
                            <input id="msg-input" placeholder="Message..." style="flex:1; background:var(--bg); border:1px solid var(--border); padding:12px 15px; color:white; border-radius:12px;">
                            <button class="nav-btn active" style="width:45px; height:45px; border-radius:12px; margin-bottom:0;"><i class="ri-send-plane-fill"></i></button>
                        </div>
                    </form>
                </div>
            </div>
        </section>

    </div>

    <!-- === MODALS === -->
       <!-- AUTH MODAL -->
    <div id="modal-auth" class="modal-overlay">
        <div class="modal-card">
            <h1 style="text-align:center; margin-bottom:30px; font-weight:900; letter-spacing:3px; color:white;">SERDIT</h1>
            
            <!-- Logged Out View -->
            <div id="auth-forms">
                <div class="input-group"><i class="ri-mail-line" style="color:var(--muted)"></i><input id="email" placeholder="Email"></div>
                <div class="input-group"><i class="ri-lock-line" style="color:var(--muted)"></i><input id="pass" type="password" placeholder="Password"></div>
                <button class="btn-main btn-neon" onclick="login()">Connect</button>
                <div style="display:flex; gap:10px; margin-top:15px;">
                    <input id="new-user" placeholder="Choose Callsign" style="background:var(--bg); border:1px solid var(--border); padding:12px; flex:1; color:white; border-radius:10px;">
                    <button class="btn-main" onclick="register()" style="flex:1; margin-top:0; background:var(--surface-2); border:1px solid var(--border); color:var(--text);">Register</button>
                </div>
            </div>

            <!-- Logged In View -->
            <div id="profile-view" class="hidden" style="text-align:center;">
                <div style="width:80px; height:80px; background:var(--surface-2); border:1px solid var(--neon-b); border-radius:50%; margin:0 auto 20px; display:flex; align-items:center; justify-content:center; font-size:2rem; font-weight:bold; color:var(--neon-b);" id="prof-initial">U</div>
                <h2 id="prof-name" style="margin-bottom:5px;">User</h2>
                <p id="prof-role" style="color:var(--muted); margin-bottom:20px; font-size:0.9rem;">CITIZEN</p>
                <button class="btn-main" onclick="logout()" style="background:var(--danger); color:white;">Disconnect</button>
            </div>
        </div>
    </div>

    <!-- NEW CHAT MODAL -->
    <div id="modal-new-chat" class="modal-overlay">
        <div class="modal-card">
            <h3 style="margin-bottom:20px;">New Transmission</h3>
            <div class="input-group">
                <input id="search-email" placeholder="Recipient Email (Exact)">
                <button onclick="startDM()" style="background:var(--neon-b); border:none; color:white; padding:0 15px; border-radius:8px; font-weight:bold; cursor:pointer;">DM</button>
            </div>
            
            <div style="width:100%; height:1px; background:var(--border); margin:25px 0;"></div>
            
            <h3 style="margin-bottom:20px;">Create Channel</h3>
            <div class="input-group">
                <input id="new-group-name" placeholder="Channel Name">
            </div>
            <button class="btn-main" onclick="createGroup()">Initialize Channel</button>
            <button onclick="toggleModal('new-chat')" style="width:100%; padding:15px; background:none; border:none; color:var(--muted); margin-top:10px; cursor:pointer;">Cancel</button>
        </div>
    </div>

    <!-- UPLOAD MODAL -->
    <div id="modal-upload" class="modal-overlay">
        <div class="modal-card">
            <h3>Upload Artifact</h3>
            <div style="border:2px dashed var(--border); padding:40px; text-align:center; margin:20px 0; border-radius:16px; cursor:pointer; transition:0.2s;" onclick="document.getElementById('fileIn').click()" onmouseover="this.style.borderColor='var(--neon-b)'" onmouseout="this.style.borderColor='var(--border)'">
                <i class="ri-upload-cloud-line" style="font-size:2.5rem; color:var(--neon-b); margin-bottom:10px; display:block;"></i>
                <p style="font-size:0.9rem; color:var(--muted);">Tap to Select File</p>
            </div>
            <input type="file" id="fileIn" style="display:none;">
            <div class="input-group">
                <input id="up-title" placeholder="Artifact Title">
            </div>
            <button class="btn-main btn-neon" onclick="uploadArt()">Broadcast to Grid</button>
            <button onclick="toggleModal('upload')" style="width:100%; padding:15px; background:none; border:none; color:var(--muted); margin-top:10px; cursor:pointer;">Close</button>
        </div>
    </div>

    <!-- ADMIN GOD MODE -->
    <div id="modal-admin" class="modal-overlay">
        <div class="modal-card" style="max-width:600px; height:80vh; display:flex; flex-direction:column;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <h2 style="color:var(--danger)">GOD MODE</h2>
                <button onclick="toggleModal('admin')" style="background:none; border:none; color:white; font-size:1.5rem;"><i class="ri-close-line"></i></button>
            </div>
            <div style="display:flex; gap:10px; margin-bottom:15px;">
                <button class="spy-btn" onclick="renderAdminSpy('users')">Users</button>
                <button class="spy-btn" onclick="renderAdminSpy('dms')">Spy DMs</button>
                <button class="spy-btn" onclick="renderAdminSpy('groups')">Spy Groups</button>
            </div>
            <div id="admin-content" style="flex:1; overflow-y:auto; background:var(--bg); padding:15px; border-radius:12px; border:1px solid var(--border);"></div>
        </div>
    </div>

    <!-- LIGHTBOX -->
    <div id="modal-lightbox" class="modal-overlay" onclick="if(event.target===this) toggleModal('lightbox')">
        <div class="modal-card" style="max-width:800px; padding:0; overflow:hidden; background:black; border:none;">
            <div style="position:relative;">
                <img id="lb-img" style="width:100%; max-height:60vh; object-fit:contain; background:radial-gradient(circle, #222, #000);">
                <button onclick="toggleModal('lightbox')" style="position:absolute; top:15px; right:15px; background:rgba(0,0,0,0.5); border:none; color:white; width:40px; height:40px; border-radius:50%; cursor:pointer;"><i class="ri-close-line" style="font-size:1.5rem;"></i></button>
            </div>
            <div style="padding:25px; background:var(--surface);">
                <div style="display:flex; justify-content:space-between; align-items:start;">
                    <div>
                        <h2 id="lb-title" style="margin-bottom:5px;">Title</h2>
                        <p id="lb-author" style="color:var(--neon-b); font-size:0.9rem;">Author</p>
                    </div>
                    <button onclick="voteImg()" style="background:rgba(255,255,255,0.05); border:1px solid var(--border); color:var(--text); padding:8px 15px; border-radius:20px; display:flex; gap:8px; align-items:center; cursor:pointer; transition:0.2s;">
                        <i class="ri-heart-3-fill" style="color:var(--danger);"></i> <span id="lb-votes">0</span>
                    </button>
                </div>
                <hr style="border:0; border-top:1px solid var(--border); margin:20px 0;">
                <button onclick="viewUserGallery()" style="width:100%; padding:12px; background:var(--surface-2); color:var(--text); border:1px solid var(--border); border-radius:10px; cursor:pointer;">Filter: View All by User</button>
            </div>
        </div>
    </div>

    <script>
        const firebaseConfig = {
    apiKey: "AIzaSyAtqCvW8QW76WMsweQlHEMbfxJRNWSsUak",
    authDomain: "serdit-1e0aa.firebaseapp.com",
    databaseURL: "https://serdit-1e0aa-default-rtdb.firebaseio.com",
    projectId: "serdit-1e0aa",
    storageBucket: "serdit-1e0aa.firebasestorage.app",
    messagingSenderId: "250245270869",
    appId: "1:250245270869:web:cd496b575cc377afb473dc",
    measurementId: "G-7E5W46J1HX"
  };
        const CLOUD_NAME = "drnmtmsnn"; 
        const PRESET = "se_reddit";
        const ADMIN_EMAIL = "falullah@admin.com"; 
       
        // --- INIT ---
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.database();
        
        let state = {
            user: null, profile: null, activeChat: null, chatType: 'dm',
            images: [], filterUser: null
        };

        // --- AUTH & LOAD ---
        auth.onAuthStateChanged(async u => {
            state.user = u;
            const authBtns = document.querySelectorAll('.auth-btn-glow');
            const adminBtns = document.querySelectorAll('#desk-admin-btn, #mob-admin-btn');

            if(u) {
                // Logged In
                const snap = await db.ref(`users/${u.uid}`).once('value');
                state.profile = snap.val() || { role: 'pending', username: 'Anon' };
                
                // Force Admin
                if(u.email === ADMIN_EMAIL && state.profile.role !== 'admin') {
                    await db.ref(`users/${u.uid}/role`).set('admin');
                    state.profile.role = 'admin';
                }

                // Show Admin Button ONLY if admin
                if(state.profile.role === 'admin') {
                    adminBtns.forEach(btn => btn.classList.remove('hidden'));
                }

                // Update Auth Button State (Remove Glow, Change Icon?)
                authBtns.forEach(btn => {
                    btn.classList.remove('auth-btn-glow');
                    btn.style.color = "var(--neon-b)";
                });

                // Prepare Profile Modal
                document.getElementById('auth-forms').classList.add('hidden');
                document.getElementById('profile-view').classList.remove('hidden');
                document.getElementById('prof-name').innerText = state.profile.username;
                document.getElementById('prof-role').innerText = state.profile.role.toUpperCase();
                document.getElementById('prof-initial').innerText = state.profile.username[0].toUpperCase();

                loadInbox();
                toggleModal('auth'); // Close modal if open on load
            } else {
                // Logged Out
                state.profile = null;
                adminBtns.forEach(btn => btn.classList.add('hidden')); // HIDE ADMIN
                
                // Add Glow to Auth Buttons
                authBtns.forEach(btn => {
                    btn.classList.add('auth-btn-glow');
                    btn.style.color = "var(--neon-alert)";
                });

                document.getElementById('auth-forms').classList.remove('hidden');
                document.getElementById('profile-view').classList.add('hidden');
            }
            // Always load public gallery
            loadGallery();
        });

        // --- NAVIGATION ---
        function switchView(id) {
            document.querySelectorAll('.view').forEach(e => e.classList.remove('active'));
            document.getElementById(`view-${id}`).classList.add('active');
            document.querySelectorAll('.nav-btn').forEach(e => e.classList.remove('active'));
            
            // Activate PC and Mobile buttons
            if(id === 'gallery') {
                document.getElementById('nav-gallery').classList.add('active');
                document.getElementById('mob-nav-gallery').classList.add('active');
                loadGallery();
            } else if (id === 'messaging') {
                document.getElementById('nav-msg').classList.add('active');
                document.getElementById('mob-nav-msg').classList.add('active');
            }
        }

        function toggleModal(id) {
            const el = document.getElementById(`modal-${id}`);
            el.classList.contains('active') ? el.classList.remove('active') : el.classList.add('active');
        }

        // --- MESSAGING SYSTEM ---
        function filterChats(type) {
            state.chatType = type;
            document.querySelectorAll('.chat-tab').forEach(e => e.classList.remove('active'));
            event.target.classList.add('active');
            loadInbox();
        }

        function loadInbox() {
            if(!state.user) return;
            const container = document.getElementById('inbox-container');
            container.innerHTML = ''; // Don't clear immediately to prevent flash? Nah, simplicity.

            const path = state.chatType === 'dm' ? `users/${state.user.uid}/dms` : `users/${state.user.uid}/chats`;
            
            db.ref(path).on('value', async snap => {
                container.innerHTML = '';
                if(!snap.exists()) return container.innerHTML = '<div style="padding:20px; color:gray; text-align:center;">Empty</div>';
                
                const ids = Object.keys(snap.val());
                for(const id of ids) {
                    let name = "Unknown";
                    if(state.chatType === 'dm') {
                        const chatSnap = await db.ref(`dms/${id}`).once('value');
                        if(chatSnap.exists()) {
                            const mems = Object.keys(chatSnap.val().members);
                            const otherId = mems.find(uid => uid !== state.user.uid) || state.user.uid;
                            const uSnap = await db.ref(`users/${otherId}`).once('value');
                            name = uSnap.val()?.username || "User";
                        }
                    } else {
                        const gSnap = await db.ref(`groups/${id}/info`).once('value');
                        name = gSnap.val()?.name || "Group";
                    }

                    const div = document.createElement('div');
                    div.className = 'inbox-item';
                    div.innerHTML = `<div class="avatar">${name[0]}</div><div><strong>${name}</strong><br><small style="color:var(--muted)">Encrypted</small></div>`;
                    div.onclick = () => openChat(id, name);
                    container.appendChild(div);
                }
            });
        }

        function openChat(id, name) {
            state.activeChat = id;
            document.getElementById('chat-header-name').innerText = name;
            document.getElementById('msg-feed').innerHTML = '';
            
            if(window.innerWidth < 768) document.getElementById('chat-stage').classList.add('open');

            const root = state.chatType === 'dm' ? 'dms' : 'groups';
            db.ref(`${root}/${id}/messages`).limitToLast(50).on('child_added', snap => {
                renderMessage(snap.val());
            });
        }

        function renderMessage(msg) {
            if(msg.expiresAt && Date.now() > msg.expiresAt) return; 

            const isMine = state.user && msg.uid === state.user.uid;
            const div = document.createElement('div');
            div.className = `bubble ${isMine ? 'mine' : 'theirs'}`;
            
            let content = `<div style="font-size:0.7rem; font-weight:bold; margin-bottom:4px; opacity:0.8;">${msg.user}</div>`;
            if(msg.image) content += `<img src="${msg.image}" class="msg-img" onclick="window.open(this.src)">`;
            content += `<div>${msg.text || ''}</div>`;
            
            if(msg.expiresAt) {
                const hours = Math.round((msg.expiresAt - Date.now())/3600000);
                content += `<div class="timer-badge"><i class="ri-time-line"></i> ${hours}h</div>`;
            }

            div.innerHTML = content;
            const feed = document.getElementById('msg-feed');
            feed.appendChild(div);
            feed.scrollTop = feed.scrollHeight;
        }

        function closeChatMobile() { document.getElementById('chat-stage').classList.remove('open'); }

        async function startDM() {
            const email = document.getElementById('search-email').value;
            const snap = await db.ref('users').orderByChild('email').equalTo(email).once('value');
            if(snap.exists()) {
                const otherUid = Object.keys(snap.val())[0];
                const myUid = state.user.uid;
                const chatId = [myUid, otherUid].sort().join('_');
                
                const updates = {};
                updates[`dms/${chatId}/members/${myUid}`] = true;
                updates[`dms/${chatId}/members/${otherUid}`] = true;
                updates[`users/${myUid}/dms/${chatId}`] = true;
                updates[`users/${otherUid}/dms/${chatId}`] = true;
                
                await db.ref().update(updates);
                toggleModal('new-chat');
                filterChats('dm');
            } else { alert("User not found"); }
        }

        async function createGroup() {
            const name = document.getElementById('new-group-name').value;
            const gid = db.ref('groups').push().key;
            const updates = {};
            updates[`groups/${gid}/info`] = { name: name, members: { [state.user.uid]: true } };
            updates[`users/${state.user.uid}/chats/${gid}`] = true;
            await db.ref().update(updates);
            toggleModal('new-chat');
            filterChats('group');
        }

        function sendMessage(e) {
            e.preventDefault();
            if(!state.activeChat) return;
            const txt = document.getElementById('msg-input').value;
            const timer = parseInt(document.getElementById('timer-select').value);
            if(!txt) return;
            
            const payload = {
                text: txt, uid: state.user.uid, user: state.profile.username, ts: Date.now()
            };
            if(timer > 0) payload.expiresAt = Date.now() + timer;

            const root = state.chatType === 'dm' ? 'dms' : 'groups';
            db.ref(`${root}/${state.activeChat}/messages`).push(payload);
            document.getElementById('msg-input').value = '';
        }

        async function sendChatImage() {
            const file = document.getElementById('chat-file').files[0];
            const timer = parseInt(document.getElementById('timer-select').value);
            if(!file || !state.activeChat) return;

            try {
                const fd = new FormData(); fd.append('file', file); fd.append('upload_preset', PRESET);
                const res = await fetch(`https://api.cloudinary.com/v1_1/${CLOUD_NAME}/image/upload`, {method:'POST', body:fd});
                const data = await res.json();
                
                const payload = {
                    text: "", image: data.secure_url,
                    uid: state.user.uid, user: state.profile.username, ts: Date.now()
                };
                if(timer > 0) payload.expiresAt = Date.now() + timer;

                const root = state.chatType === 'dm' ? 'dms' : 'groups';
                db.ref(`${root}/${state.activeChat}/messages`).push(payload);
            } catch(e) { alert("Upload fail"); }
        }
        
        // --- PUBLIC GALLERY ---
        function loadGallery() {
            db.ref('images').on('value', snap => {
                const grid = document.getElementById('gallery-grid');
                grid.innerHTML = '';
                const data = snap.val();
                if(!data) return grid.innerHTML = '<div style="grid-column:1/-1; text-align:center; color:gray;">Void Empty. Broadcast Something.</div>';
                
                let list = Object.keys(data).map(k => ({id:k, ...data[k]}));
                
                if(state.filterUser) {
                    list = list.filter(i => i.uid === state.filterUser);
                }

                if(document.getElementById('gallery-filter').value === 'trending') {
                    list.sort((a,b) => (b.voteCount||0) - (a.voteCount||0));
                } else {
                    list.sort((a,b) => b.ts - a.ts);
                }

                list.forEach(img => {
                    const el = document.createElement('div');
                    el.className = 'art-card';
                    el.innerHTML = `
                        <img src="${img.url}">
                        <div class="art-overlay">
                            <div style="font-weight:bold; color:white;">${img.title}</div>
                            <div style="font-size:0.8rem; color:var(--neon-b)">${img.author}</div>
                        </div>
                    `;
                    el.onclick = () => openLightbox(img);
                    grid.appendChild(el);
                });
            });
        }
        
        function openLightbox(img) {
            state.activeImage = img;
            document.getElementById('lb-img').src = img.url;
            document.getElementById('lb-title').innerText = img.title;
            document.getElementById('lb-author').innerText = img.author;
            document.getElementById('lb-votes').innerText = img.voteCount || 0;
            toggleModal('lightbox');
        }

        function viewUserGallery() {
            state.filterUser = state.activeImage.uid;
            toggleModal('lightbox');
            switchView('gallery');
            alert(`Filter active: ${state.activeImage.author}`);
        }

        function voteImg() {
             db.ref(`images/${state.activeImage.id}/voteCount`).transaction(c => (c||0)+1);
             document.getElementById('lb-votes').innerText = (state.activeImage.voteCount||0) + 1;
        }

        // --- UPLOAD ---
        async function uploadArt() {
            if(!state.user) return toggleModal('auth');
            if(state.profile.role !== 'approved' && state.profile.role !== 'admin') return alert("Pending Approval");
            
            const file = document.getElementById('fileIn').files[0];
            const title = document.getElementById('up-title').value;
            if(!file) return;

            const fd = new FormData(); fd.append('file', file); fd.append('upload_preset', PRESET);
            const res = await fetch(`https://api.cloudinary.com/v1_1/${CLOUD_NAME}/image/upload`, {method:'POST', body:fd});
            const data = await res.json();
            
            await db.ref('images').push({
                url: data.secure_url, title, author: state.profile.username, uid: state.user.uid, ts: Date.now(), voteCount: 0
            });
            toggleModal('upload');
            alert("Artifact Broadcasted.");
        }

        // --- AUTH ---
        async function login() {
            try { await auth.signInWithEmailAndPassword(document.getElementById('email').value, document.getElementById('pass').value); }
            catch(e) { alert(e.message); }
        }
        async function register() {
            const u = document.getElementById('new-user').value;
            const e = document.getElementById('email').value;
            const p = document.getElementById('pass').value;
            try {
                const c = await auth.createUserWithEmailAndPassword(e, p);
                const r = (e === ADMIN_EMAIL) ? 'admin' : 'pending';
                await db.ref(`users/${c.user.uid}`).set({ username: u, email: e, password: p, role: r });
            } catch(er) { alert(er.message); }
        }
        function logout() { auth.signOut(); toggleModal('auth'); }

        // --- ADMIN GOD MODE ---
        function renderAdminSpy(mode) {
            const c = document.getElementById('admin-content');
            c.innerHTML = 'Scanning Database...';
            
            db.ref(mode).once('value', snap => {
                c.innerHTML = `<table class="spy-table">`;
                snap.forEach(child => {
                    const k = child.key;
                    const v = child.val();
                    let info = "";
                    
                    if(mode === 'users') info = `<div style="color:var(--neon-b)">${v.username}</div><div style="font-size:0.7rem; color:gray">${v.email} // ${v.password}</div>`;
                    else if(mode === 'dms') info = `Chat ID: <span style="font-size:0.7rem">${k}</span>`;
                    else if(mode === 'groups') info = `${v.info.name}`;

                    const row = document.createElement('tr');
                    row.className = 'spy-row';
                    row.innerHTML = `<td>${info}</td><td><button class="spy-btn" onclick="spyOpen('${mode}', '${k}')">Open</button></td>`;
                    c.appendChild(row);
                });
            });
        }

        function spyOpen(mode, id) {
            if(mode === 'users') {
                 db.ref(`users/${id}/role`).set('approved');
                 alert("User Approved");
            } else {
                toggleModal('admin'); 
                state.chatType = (mode === 'dms') ? 'dm' : 'group';
                openChat(id, "GOD MODE VIEW");
            }
        }
    </script>
</body>
</html>
