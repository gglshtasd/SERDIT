<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>SERDIT | Panopticon</title>
    
    <!-- FONTS -->
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;700&family=JetBrains+Mono:wght@400;800&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
    
    <!-- CORE ENGINE -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.6/purify.min.js"></script>
    
    <!-- AI & MEDIA ENGINE -->
    <!-- TensorFlow.js for Client-Side Analysis -->
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/toxicity"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd"></script>

    <style>
        /* --- THEME: VOID/NEON --- */
        :root {
            --bg: #030304;
            --surface: #0a0a0c;
            --surface-2: #141419;
            --border: #22222a;
            --neon-blue: #3b82f6;
            --neon-red: #ef4444;
            --neon-green: #10b981;
            --text: #e2e8f0;
            --text-muted: #64748b;
            --font-main: 'Space Grotesk', sans-serif;
            --font-code: 'JetBrains Mono', monospace;
            --nav-w: 280px;
        }

        /* --- RESET & BASE --- */
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; background: var(--bg); color: var(--text); font-family: var(--font-main); height: 100dvh; overflow: hidden; display: flex; user-select: none; }
        input, textarea, button { font-family: inherit; outline: none; }
        
        /* SCROLLBARS */
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 2px; }

        /* --- LIQUID LAYOUT --- */
        .app-shell { display: flex; width: 100%; height: 100%; position: relative; }
        
        /* SIDEBAR (Drawer on Mobile) */
        .sidebar {
            width: var(--nav-w); background: var(--surface); border-right: 1px solid var(--border);
            display: flex; flex-direction: column; z-index: 100; flex-shrink: 0;
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .main-stage { flex: 1; position: relative; background: var(--bg); display: flex; flex-direction: column; overflow: hidden; }

        /* --- NEXUS (CHAT) --- */
        .nexus-layout { display: flex; height: 100%; position: relative; }
        
        .chat-list-pane { 
            width: 320px; background: var(--surface); border-right: 1px solid var(--border); 
            display: flex; flex-direction: column; z-index: 50; transition: transform 0.3s;
        }
        
        .chat-view-pane { 
            flex: 1; display: flex; flex-direction: column; background: var(--bg); 
            position: relative; z-index: 40;
        }

        /* Responsive Logic */
        @media (max-width: 768px) {
            .sidebar { position: fixed; inset: 0; width: 100%; transform: translateX(-100%); }
            .sidebar.open { transform: translateX(0); }
            
            .chat-list-pane { width: 100%; position: absolute; inset: 0; }
            .chat-view-pane { position: absolute; inset: 0; transform: translateX(100%); transition: transform 0.3s; z-index: 60; }
            .chat-view-pane.active { transform: translateX(0); }
            
            .mobile-menu-btn { display: flex !important; }
        }

        /* Chat Items */
        .chat-item { padding: 15px; border-bottom: 1px solid var(--border); cursor: pointer; display: flex; align-items: center; gap: 12px; transition: 0.2s; }
        .chat-item:active { background: var(--surface-2); }
        .chat-item.active { background: rgba(59, 130, 246, 0.1); border-left: 3px solid var(--neon-blue); }
        
        .msg-feed { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 6px; padding-bottom: 100px; }
        
        /* Bubbles */
        .bubble { max-width: 85%; padding: 10px 14px; border-radius: 12px; font-size: 0.95rem; line-height: 1.4; position: relative; word-wrap: break-word; }
        .bubble.mine { align-self: flex-end; background: var(--neon-blue); color: white; border-bottom-right-radius: 2px; }
        .bubble.theirs { align-self: flex-start; background: var(--surface-2); color: #ccc; border: 1px solid var(--border); border-bottom-left-radius: 2px; }
        .bubble.deleted { border: 1px dashed var(--neon-red); background: transparent !important; color: var(--neon-red); font-style: italic; }
        .bubble img, .bubble video { max-width: 100%; border-radius: 8px; margin-top: 5px; cursor: pointer; }
        .bubble.blur-img img { filter: blur(20px); transition: 0.3s; }
        .bubble.blur-img img:hover { filter: blur(0); }

        /* Input Area */
        .input-dock { background: var(--surface); border-top: 1px solid var(--border); padding: 10px; display: flex; align-items: flex-end; gap: 10px; z-index: 70; }
        .msg-input { flex: 1; background: var(--bg); border: 1px solid var(--border); border-radius: 20px; padding: 12px; color: white; min-height: 44px; max-height: 120px; resize: none; }
        
        /* --- 3D GALLERY --- */
        .gallery-stage { height: 100%; perspective: 1000px; display: flex; align-items: center; justify-content: center; overflow: hidden; background: radial-gradient(circle at center, #111 0%, #000 100%); }
        .coverflow { display: flex; transform-style: preserve-3d; transition: transform 0.5s; }
        .art-card { width: 200px; height: 300px; margin: 0 20px; -webkit-box-reflect: below 2px linear-gradient(transparent, transparent, #0004); position: relative; transition: 0.5s; }
        .art-card img { width: 100%; height: 100%; object-fit: cover; border-radius: 8px; border: 2px solid var(--border); }
        .art-tag { position: absolute; bottom: 5px; left: 5px; background: rgba(0,0,0,0.8); font-size: 0.6rem; padding: 2px 6px; border-radius: 4px; color: var(--neon-blue); }

        /* --- UI COMPONENTS --- */
        .btn { padding: 12px; background: var(--neon-blue); border: none; color: white; border-radius: 8px; font-weight: 700; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; font-size: 0.9rem; }
        .btn.ghost { background: var(--surface-2); color: var(--text-muted); border: 1px solid var(--border); }
        .btn.danger { background: var(--neon-red); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; filter: grayscale(1); }

        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.95); backdrop-filter: blur(5px); z-index: 5000; display: none; align-items: center; justify-content: center; opacity: 0; transition: opacity 0.2s; }
        .modal.active { display: flex; opacity: 1; }
        .card { background: var(--surface); border: 1px solid var(--border); padding: 25px; border-radius: 16px; width: 90%; max-width: 450px; position: relative; box-shadow: 0 0 50px rgba(0,0,0,0.8); max-height: 90vh; overflow-y: auto; }

        .inp-group { margin-bottom: 15px; }
        .inp { width: 100%; background: var(--bg); border: 1px solid var(--border); padding: 12px; color: white; border-radius: 8px; font-family: var(--font-code); }
        .label { font-size: 0.75rem; color: var(--text-muted); margin-bottom: 5px; display: block; font-family: var(--font-code); }

        .god-badge { position: fixed; top: 15px; right: 15px; background: var(--neon-red); color: white; padding: 4px 10px; font-size: 0.7rem; font-weight: 800; border-radius: 20px; box-shadow: 0 0 15px var(--neon-red); z-index: 9999; display: none; pointer-events: none; font-family: var(--font-code); }
        .mobile-menu-btn { display: none; position: absolute; top: 15px; left: 15px; z-index: 100; background: #000; border: 1px solid var(--border); width: 40px; height: 40px; align-items: center; justify-content: center; border-radius: 8px; color: white; cursor: pointer; }
    </style>
</head>
<body>

    <div id="god-badge" class="god-badge">GOD MODE</div>
    <div id="toast-box" style="position:fixed; top:20px; left:50%; transform:translateX(-50%); z-index:9000; width: 90%; max-width: 300px;"></div>

    <!-- MAIN APP STRUCTURE -->
    <div class="app-shell">
        
        <!-- SIDEBAR -->
        <nav class="sidebar" id="sidebar">
            <div style="padding: 40px 20px; text-align: center; border-bottom: 1px solid var(--border);">
                <div style="font-family: var(--font-code); font-size: 2rem; letter-spacing: -2px;">S<span style="color:var(--neon-blue)">ERDIT</span></div>
                <div style="font-size: 0.6rem; letter-spacing: 3px; color: var(--neon-red); margin-top: 5px;">PANOPTICON V5.0</div>
            </div>

            <div style="flex: 1; padding: 20px; display: flex; flex-direction: column; gap: 10px; overflow-y: auto;">
                <button class="btn ghost" onclick="switchView('nexus')"><i class="ri-chat-3-fill"></i> NEXUS</button>
                <button class="btn ghost" onclick="switchView('gallery')"><i class="ri-gallery-fill"></i> CHRONOS</button>
                <div style="flex:1"></div>
                
                <div id="quota-display" style="font-family:var(--font-code); font-size:0.7rem; color:var(--text-muted); text-align:center; padding: 10px; border:1px solid var(--border); border-radius:8px; margin-bottom:10px;">
                    STORAGE: <span id="storage-val">0</span> / <span id="storage-max">100</span> MB
                </div>

                <button id="god-panel-btn" class="btn danger" style="display:none" onclick="toggleModal('god-panel')"><i class="ri-eye-2-line"></i> GOD PANEL</button>
                <button class="btn" onclick="toggleModal('auth')">IDENTITY</button>
            </div>
        </nav>

        <div class="main-stage">
            
            <!-- VIEW: NEXUS (CHAT) -->
            <div id="view-nexus" class="nexus-layout">
                <!-- Mobile Menu Trigger -->
                <button class="mobile-menu-btn" onclick="toggleSidebar()"><i class="ri-menu-4-fill"></i></button>

                <!-- Chat List -->
                <div class="chat-list-pane" id="chat-list-pane">
                    <div style="padding:15px; border-bottom:1px solid var(--border); padding-top: 70px;"> <!-- Padding top for mobile btn -->
                        <input class="inp" placeholder="Search Frequency..." onkeyup="filterChats(this.value)">
                    </div>
                    <div id="chat-list-container" style="overflow-y:auto; flex:1;"></div>
                </div>

                <!-- Chat Stage -->
                <div class="chat-view-pane" id="chat-stage">
                    <!-- Header -->
                    <div style="height:60px; border-bottom:1px solid var(--border); display:flex; align-items:center; padding:0 15px; background:var(--surface);">
                        <button class="btn ghost" style="width:35px; height:35px; padding:0; margin-right:10px; display:none;" id="back-btn" onclick="closeChatMobile()"><i class="ri-arrow-left-s-line"></i></button>
                        <div>
                            <div style="font-weight:700;" id="chat-header-title">Select Frequency</div>
                            <div style="font-size:0.7rem; color:var(--neon-green);">Signal Encrypted</div>
                        </div>
                    </div>

                    <!-- Feed -->
                    <div id="chat-feed" class="msg-feed"></div>

                    <!-- Input -->
                    <div class="input-dock" id="input-dock">
                        <input type="file" id="media-up" hidden onchange="handleMediaSelect()">
                        <button class="btn ghost" style="width:40px; height:40px; padding:0;" onclick="document.getElementById('media-up').click()"><i class="ri-attachment-2"></i></button>
                        <textarea id="msg-input" class="msg-input" placeholder="Transmit..." rows="1"></textarea>
                        <button id="send-btn" class="btn" style="width:50px; height:50px; border-radius:50%;" onclick="sendMessage()"><i class="ri-send-plane-fill"></i></button>
                    </div>

                    <!-- Lock Screen -->
                    <div id="lock-screen" style="position:absolute; inset:0; background:var(--bg); z-index:80; display:flex; align-items:center; justify-content:center; flex-direction:column; color:var(--text-muted);">
                        <i class="ri-lock-2-fill" style="font-size:3rem; margin-bottom:15px; color:var(--neon-red);"></i>
                        <div>SURVEILLANCE LOCK ACTIVE</div>
                        <div style="font-size:0.7rem;">Set Secondary Password to Unlock</div>
                    </div>
                </div>
            </div>

            <!-- VIEW: GALLERY -->
            <div id="view-gallery" style="display: none; height:100%;">
                <div class="gallery-stage">
                    <div style="position:absolute; top:20px; right:20px; z-index:100; display:flex; gap:10px;">
                        <button class="mobile-menu-btn" style="position:static; display:flex !important;" onclick="toggleSidebar()"><i class="ri-menu-4-fill"></i></button>
                        <button class="btn" onclick="document.getElementById('gal-up').click()">UPLOAD</button>
                        <input type="file" id="gal-up" hidden onchange="uploadGallery()">
                    </div>
                    <div id="coverflow-track" class="coverflow"></div>
                </div>
            </div>

        </div>
    </div>

    <!-- MODALS -->
    
    <!-- AUTH -->
    <div id="modal-auth" class="modal">
        <div class="card">
            <h2 style="font-family:var(--font-code); color:var(--neon-blue);">IDENTITY</h2>
            <div id="auth-main">
                <button class="btn" style="width:100%; margin-bottom:10px;" onclick="loginGoogle()"><i class="ri-google-fill"></i> GOOGLE LINK</button>
                <button class="btn ghost" style="width:100%;" onclick="showGhostForm()">GHOST REQUEST</button>
            </div>
            <div id="auth-ghost" style="display:none;">
                <div class="inp-group"><input id="g-code" class="inp" placeholder="Codename"></div>
                <div class="inp-group"><input id="g-pass" class="inp" type="password" placeholder="Passcode"></div>
                <button class="btn" style="width:100%;" onclick="submitGhost()">REQUEST ACCESS</button>
                <button class="btn ghost" style="width:100%; margin-top:10px;" onclick="resetAuth()">BACK</button>
            </div>
        </div>
    </div>

    <!-- SECONDARY SECURITY -->
    <div id="modal-security" class="modal" style="z-index:6000;">
        <div class="card" style="border-color:var(--neon-red);">
            <h2 style="color:var(--neon-red);">LEVEL 2 SECURITY</h2>
            <p style="font-size:0.8rem; color:#888; margin-bottom:15px;">Mandatory surveillance password required.</p>
            <div class="inp-group">
                <label class="label">SURVEILLANCE PASSWORD</label>
                <input id="sec-pass" class="inp" type="password">
            </div>
            <div class="inp-group">
                <label class="label">GEMINI API KEY (OPTIONAL - FOR ORACLE)</label>
                <input id="gemini-key" class="inp" placeholder="AIzaSy...">
            </div>
            <button class="btn danger" style="width:100%;" onclick="saveSecurity()">CONFIRM IDENTITY</button>
        </div>
    </div>

    <!-- VIDEO TRIMMER -->
    <div id="modal-video" class="modal">
        <div class="card">
            <h3>VIDEO TRIMMER</h3>
            <p style="font-size:0.7rem; color:#888;">Client-Side Processing (FFmpeg/HTML5)</p>
            <video id="video-preview" controls style="width:100%; max-height:200px; margin:10px 0; border:1px solid var(--border);"></video>
            <div class="inp-group" style="display:flex; gap:10px;">
                <div style="flex:1"><label class="label">START (SEC)</label><input id="vid-start" class="inp" type="number" value="0"></div>
                <div style="flex:1"><label class="label">END (SEC)</label><input id="vid-end" class="inp" type="number" value="10"></div>
            </div>
            <button class="btn" style="width:100%;" onclick="processVideo()">PROCESS & UPLOAD</button>
        </div>
    </div>

    <!-- GOD PANEL -->
    <div id="modal-god-panel" class="modal">
        <div class="card" style="max-width:600px; height: 80vh;">
            <div style="display:flex; justify-content:space-between;">
                <h2 style="color:var(--neon-red);">GOD MODE</h2>
                <button style="background:none; border:none; color:#666;" onclick="toggleModal('god-panel')">X</button>
            </div>
            
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin:20px 0;">
                <div style="padding:15px; border:1px solid var(--border); border-radius:8px;">
                    <div class="label">USERS</div>
                    <div id="stat-users" style="font-size:1.5rem;">-</div>
                </div>
                <div style="padding:15px; border:1px solid var(--border); border-radius:8px;">
                    <div class="label">TOTAL STORAGE</div>
                    <div id="stat-storage-total" style="font-size:1.5rem;">- MB</div>
                </div>
            </div>

            <h3 style="font-size:0.9rem; margin-top:20px;">DEEP FREEZE (AWS)</h3>
            <button class="btn ghost" style="width:100%; margin-bottom:20px;" onclick="exportDeepFreeze()"><i class="ri-hard-drive-2-line"></i> EXPORT DB JSON</button>

            <h3 style="font-size:0.9rem;">USER QUOTAS</h3>
            <div id="admin-user-list" style="max-height:200px; overflow-y:auto; border:1px solid var(--border); border-radius:8px;"></div>
        </div>
    </div>

    <script>
        // --- CONFIGURATION ---
        const firebaseConfig = {
            apiKey: "AIzaSyAtqCvW8QW76WMsweQlHEMbfxJRNWSsUak",
            authDomain: "serdit-1e0aa.firebaseapp.com",
            databaseURL: "https://serdit-1e0aa-default-rtdb.firebaseio.com",
            projectId: "serdit-1e0aa",
            storageBucket: "serdit-1e0aa.firebasestorage.app",
            messagingSenderId: "250245270869",
            appId: "1:250245270869:web:cd496b575cc377afb473dc"
        };
        const CLOUD_NAME = "drnmtmsnn"; 
        const CLOUD_PRESET = "serdit_preset"; // Unsigned preset

        // --- INIT ---
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.database();
        const provider = new firebase.auth.GoogleAuthProvider();

        let state = {
            user: null,
            profile: null,
            isAdmin: false,
            activeChat: null,
            limits: { video: 20, storage: 100 }, // Defaults
            tempFile: null,
            models: { toxicity: null, coco: null }
        };

        // --- AI LOAD ---
        (async () => {
            try {
                // state.models.toxicity = await toxicity.load(0.9); // Loaded on demand to save bandwidth if needed
                console.log("AI Modules Standing By");
            } catch(e) { console.log("AI Init Warning:", e); }
        })();

        // --- AUTH FLOW ---
        auth.onAuthStateChanged(async u => {
            state.user = u;
            if (u) {
                const snap = await db.ref(`users/${u.uid}`).once('value');
                state.profile = snap.val();

                // Admin Check
                if (state.profile && state.profile.role === 'admin') {
                    state.isAdmin = true;
                    document.getElementById('god-badge').style.display = 'block';
                    document.getElementById('god-panel-btn').style.display = 'flex';
                }

                // Limits Sync
                if(state.profile && state.profile.limits) state.limits = state.profile.limits;

                // Security Check (Panopticon)
                if (state.profile && !state.profile.private?.secPass) {
                    toggleModal('security', true);
                } else if (!state.profile) {
                    // Init Profile
                    await db.ref(`users/${u.uid}`).set({
                        username: u.displayName || 'Citizen',
                        email: u.email,
                        role: 'pending',
                        storageUsed: 0,
                        joined: Date.now()
                    });
                    toggleModal('security', true);
                } else {
                    initApp();
                }
                toggleModal('auth', false);
            } else {
                // Public View
                loadChatList([{id:'global', name:'Global Frequency', type:'public'}]);
            }
        });

        function loginGoogle() { auth.signInWithPopup(provider).catch(e => toast(e.message)); }
        function showGhostForm() { document.getElementById('auth-main').style.display='none'; document.getElementById('auth-ghost').style.display='block'; }
        function resetAuth() { document.getElementById('auth-main').style.display='block'; document.getElementById('auth-ghost').style.display='none'; }
        
        function submitGhost() {
            const code = document.getElementById('g-code').value;
            const pass = document.getElementById('g-pass').value;
            if(!code || !pass) return toast("Data Missing");
            auth.createUserWithEmailAndPassword(`${code}@ghost.net`, pass).then(c => {
                db.ref(`users/${c.user.uid}`).set({
                    username: code, email: 'ghost', role:'pending', storageUsed:0,
                    private: { secPass: pass } // Auto-set sec pass for ghosts
                });
            }).catch(e=>toast(e.message));
        }

        async function saveSecurity() {
            const p = document.getElementById('sec-pass').value;
            const k = document.getElementById('gemini-key').value;
            if(p.length < 4) return toast("Password too weak");
            await db.ref(`users/${state.user.uid}/private`).update({ secPass: p, geminiKey: k });
            toggleModal('security', false);
            window.location.reload();
        }

        // --- APP LOGIC ---
        function initApp() {
            document.getElementById('lock-screen').style.display = 'none';
            document.getElementById('storage-val').innerText = (state.profile.storageUsed||0).toFixed(1);
            document.getElementById('storage-max').innerText = state.limits.storage;
            
            loadChats();
            loadGallery();
        }

        // --- NEXUS (CHAT) ---
        function loadChats() {
            // Mock Data for Prototype - In prod fetch from users/uid/chats
            const chats = [
                {id: 'global', name: 'Global Frequency', type: 'public'},
                {id: 'admin_help', name: 'Admin Support', type: 'dm'}
            ];
            loadChatList(chats);
        }

        function loadChatList(list) {
            const c = document.getElementById('chat-list-container');
            c.innerHTML = '';
            list.forEach(chat => {
                const d = document.createElement('div');
                d.className = 'chat-item';
                d.innerHTML = `
                    <div style="width:40px;height:40px;background:#222;border-radius:50%;display:flex;align-items:center;justify-content:center;">${chat.name[0]}</div>
                    <div><div style="font-weight:700;">${chat.name}</div><div style="font-size:0.7rem;color:#666;">${chat.type}</div></div>
                `;
                d.onclick = () => openChat(chat.id, chat.name);
                c.appendChild(d);
            });
        }

        function openChat(id, name) {
            state.activeChat = id;
            document.getElementById('chat-header-title').innerText = name;
            
            // Responsive Logic
            if(window.innerWidth <= 768) {
                document.getElementById('chat-stage').classList.add('active');
                document.getElementById('back-btn').style.display = 'flex';
            }

            const feed = document.getElementById('chat-feed');
            feed.innerHTML = '';
            
            // Pagination: Last 50 messages
            const ref = db.ref(`chats/${id}/messages`).limitToLast(50);
            ref.on('child_added', snap => {
                const msg = snap.val();
                if(msg.isDeleted && !state.isAdmin) {
                    renderMsg(snap.key, {...msg, text:"[Data Expunged]"}, true);
                } else {
                    renderMsg(snap.key, msg, false);
                }
                feed.scrollTop = feed.scrollHeight;
            });

            ref.on('child_changed', snap => {
                const msg = snap.val();
                const el = document.getElementById(`msg-${snap.key}`);
                if(el) {
                    el.className += " deleted";
                    el.innerText = state.isAdmin ? `[DEL] ${msg.text}` : "[Data Expunged]";
                }
            });
        }

        function renderMsg(key, msg, hidden) {
            const feed = document.getElementById('chat-feed');
            const d = document.createElement('div');
            const isMine = state.user && msg.uid === state.user.uid;
            d.id = `msg-${key}`;
            d.className = `bubble ${isMine?'mine':'theirs'} ${hidden?'deleted':''}`;
            
            if(msg.type === 'image') d.innerHTML = `<img src="${msg.url}">`;
            else if(msg.type === 'video') d.innerHTML = `<video src="${msg.url}" controls></video>`;
            else d.innerText = msg.text;

            if(state.isAdmin && msg.isDeleted) d.innerHTML += `<br><span style="color:red;font-size:0.6rem;">DELETED</span>`;

            // Long Press / Context Menu
            d.oncontextmenu = (e) => {
                e.preventDefault();
                handleMsgOption(key, msg.ts, msg.uid);
            };
            feed.appendChild(d);
        }

        // --- AI & SEND ---
        async function sendMessage() {
            const txt = document.getElementById('msg-input').value;
            if(!txt) return;

            // AI: Pre-Crime (Toxicity)
            if(state.models.toxicity) {
                const predictions = await state.models.toxicity.classify([txt]);
                const isToxic = predictions.some(p => p.results[0].match);
                if(isToxic) return toast("Blocked by Pre-Crime Filter");
            }

            // AI: Dream Protocol
            if(txt.startsWith('/imagine ')) {
                const prompt = txt.replace('/imagine ', '');
                toast("Dreaming...");
                const imgUrl = `https://image.pollinations.ai/prompt/${encodeURIComponent(prompt)}`;
                const upUrl = await uploadCloudUrl(imgUrl); // Re-upload to keep forever
                await pushMsg({ type: 'image', url: upUrl, text: `Dream: ${prompt}` });
            } else if(txt.startsWith('@system ') && state.profile.private.geminiKey) {
                // AI: Oracle
                await pushMsg({ type: 'text', text: txt });
                callOracle(txt.replace('@system ', ''), state.profile.private.geminiKey);
            } else {
                await pushMsg({ type: 'text', text: txt });
            }
            document.getElementById('msg-input').value = '';
        }

        async function pushMsg(payload) {
            await db.ref(`chats/${state.activeChat}/messages`).push({
                ...payload,
                uid: state.user.uid,
                user: state.profile.username,
                ts: Date.now(),
                isDeleted: false
            });
        }

        async function callOracle(prompt, key) {
            try {
                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=${key}`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });
                const data = await res.json();
                const reply = data.candidates[0].content.parts[0].text;
                pushMsg({ type: 'text', text: `[ORACLE]: ${reply}` }); // Note: In real app, oracle sends as system uid
            } catch(e) { pushMsg({type:'text', text: "[ORACLE ERROR]"}); }
        }

        // --- MEDIA FORGE (VIDEO & IMG) ---
        function handleMediaSelect() {
            const f = document.getElementById('media-up').files[0];
            if(!f) return;
            
            if(f.type.startsWith('video/')) {
                // Check Quota
                const sizeMB = f.size / (1024*1024);
                if(sizeMB > state.limits.video) {
                    state.tempFile = f;
                    const url = URL.createObjectURL(f);
                    document.getElementById('video-preview').src = url;
                    toggleModal('video', true);
                } else {
                    uploadMedia(f); // Direct upload if small
                }
            } else {
                uploadMedia(f);
            }
        }

        async function processVideo() {
            toast("Processing (Client-Side)...");
            // NOTE: Full FFmpeg.wasm requires SharedArrayBuffer (Headers). 
            // Fallback: We rely on Cloudinary's incoming transformation OR we allow the file if user accepts quality drop.
            // For this demo, we simulate a trim by uploading the whole file but setting playback start/end in metadata
            // OR strictly enforcing limits.
            
            // Simulating Trim Logic:
            const start = document.getElementById('vid-start').value;
            const end = document.getElementById('vid-end').value;
            
            // In a full implementation with COOP/COEP headers, we would run:
            // ffmpeg.run('-i', 'input.mp4', '-ss', start, '-to', end, 'output.mp4');
            
            // Here we upload with Cloudinary Params to trim on their server to save our bandwidth on download
            // But we still pay bandwidth on upload. 
            // To ensure "Low Cost", we reject if local processing fails.
            
            // For now, assume trimming accepted and upload original (Prototype limitation without headers)
            toggleModal('video', false);
            uploadMedia(state.tempFile); 
        }

        async function uploadMedia(file) {
            if(!state.user) return;
            
            // Check Total Quota
            const current = state.profile.storageUsed || 0;
            const sizeMB = file.size / (1024*1024);
            if(current + sizeMB > state.limits.storage) return toast("LIFETIME QUOTA EXCEEDED");

            toast("Encrypting & Uploading...");
            
            // AI Auto-Tag (Visual Cortex)
            let tags = [];
            if(file.type.startsWith('image')) {
                // Load image to canvas for TFJS
                // Skipped for brevity in Monolith, but placeholder logic:
                // const predictions = await cocoSsdModel.detect(imgElement);
                // tags = predictions.map(p => p.class);
            }

            const fd = new FormData();
            fd.append('file', file);
            fd.append('upload_preset', CLOUD_PRESET);
            if(tags.length > 0) fd.append('tags', tags.join(','));

            try {
                const res = await fetch(`https://api.cloudinary.com/v1_1/${CLOUD_NAME}/upload`, {method:'POST', body:fd});
                const data = await res.json();
                
                // Update Ledger
                await db.ref(`users/${state.user.uid}/storageUsed`).set(current + sizeMB);
                document.getElementById('storage-val').innerText = (current+sizeMB).toFixed(1);

                await pushMsg({ 
                    type: file.type.startsWith('video') ? 'video' : 'image', 
                    url: data.secure_url, 
                    text: tags.length > 0 ? `Tags: ${tags.join(', ')}` : ''
                });
            } catch(e) { toast("Upload Failed"); }
        }

        async function uploadCloudUrl(url) {
            // Helper for Pollinations re-upload
            const fd = new FormData();
            fd.append('file', url);
            fd.append('upload_preset', CLOUD_PRESET);
            const res = await fetch(`https://api.cloudinary.com/v1_1/${CLOUD_NAME}/upload`, {method:'POST', body:fd});
            const d = await res.json();
            return d.secure_url;
        }

        // --- CHRONOS GALLERY ---
        function loadGallery() {
            db.ref('images').limitToLast(20).on('value', snap => {
                const data = snap.val();
                if(!data) return;
                const t = document.getElementById('coverflow-track');
                t.innerHTML = '';
                let i = 0;
                Object.values(data).forEach(img => {
                    const d = document.createElement('div');
                    d.className = 'art-card';
                    d.style.transform = `rotateY(${i*45}deg) translateZ(300px)`;
                    d.innerHTML = `<img src="${img.url}">`;
                    t.appendChild(d);
                    i++;
                });
            });
        }
        
        async function uploadGallery() {
            // Re-uses uploadMedia logic but writes to 'images' node
            const f = document.getElementById('gal-up').files[0];
            if(f) {
                // ... same upload logic ...
                // Simplified for demo:
                uploadMedia(f); // This sends to chat. Proper gallery needs separate 'images' node write.
            }
        }

        // --- GOD MODE ---
        function handleMsgOption(key, ts, uid) {
            const now = Date.now();
            const canDel = state.isAdmin || (uid === state.user.uid && now - ts < 1800000);
            if(canDel && confirm("Delete Transmission?")) {
                db.ref(`chats/${state.activeChat}/messages/${key}`).update({ isDeleted: true });
            }
        }

        function exportDeepFreeze() {
            toast("Scraping...");
            db.ref('/').once('value', snap => {
                const blob = new Blob([JSON.stringify(snap.val())], {type:'application/json'});
                const a = document.createElement('a');
                a.href = URL.createObjectURL(blob);
                a.download = `SERDIT_DUMP_${Date.now()}.json`;
                a.click();
            });
        }

        // --- UTILS ---
        function toggleModal(id, force) {
            const m = document.getElementById(`modal-${id}`);
            if(force !== undefined) m.classList.toggle('active', force);
            else m.classList.toggle('active');
        }
        function toggleSidebar() { document.getElementById('sidebar').classList.toggle('open'); }
        function switchView(id) {
            document.getElementById('view-nexus').style.display = id==='nexus'?'flex':'none';
            document.getElementById('view-gallery').style.display = id==='gallery'?'block':'none';
            if(window.innerWidth <= 768) toggleSidebar();
        }
        function closeChatMobile() {
            document.getElementById('chat-stage').classList.remove('active');
            document.getElementById('back-btn').style.display = 'none';
        }
        function toast(msg) {
            const b = document.getElementById('toast-box');
            b.innerHTML = `<div style="background:#111;color:white;padding:10px;border:1px solid #333;margin-top:5px;border-radius:5px;">${msg}</div>`;
            setTimeout(()=>b.innerHTML='', 3000);
        }

    </script>
</body>
</html>


